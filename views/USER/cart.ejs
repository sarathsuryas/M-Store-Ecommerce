<%- include('../USERPARTIAL/header') %>

    <%- include('../USERPARTIAL/middle') %>
        <link rel="stylesheet" href="/userassets/user/css/noItemInCart.css">


        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>


        <main class="main">
            <div class="page-header breadcrumb-wrap">
                <div class="container">
                    <div class="breadcrumb">
                        <a href="index.html" rel="nofollow">Home</a>
                        <span></span> Shop
                        <span></span> Your Cart
                    </div>
                </div>
            </div>

            <!-- show cart  -->

            <% if(cart && cart.products.length>0) { %>
                <section class="mt-50 mb-50">
                    <div class="container">
                        <div class="row">
                            <div class="col-12">
                                <div class="table-responsive">

                                    <table class="table shopping-summery text-center clean">
                                        <thead>
                                            <tr class="main-heading">
                                                <th scope="col">Image</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Price</th>
                                                <th scope="col">Quantity</th>
                                                <th scope="col">Subtotal</th>
                                                <th scope="col">Remove</th>
                                            </tr>
                                        </thead>

                                        <% cart.products.forEach(product=> { %>
                                            <tbody>

                                                <!-- main row -->
                                                <tr>
                                                    <td class="image product-thumbnail"><img
                                                            src="<%= product.productId.coverImage %>" alt="#"></td>
                                                    <td class="product-des product-name w-25">
                                                        <h5 class="product-name">
                                                            <%= product.productId.title %>
                                                        </h5>
                                                    </td>
                                                    <td class="price" data-title="Price"><span>₹ <%=
                                                                product.productId.price %></span></td>
                                                    <td class="text-center" data-title="Stock">
                                                        <div class="detail-qty border radius m-auto">
                                                            <a href="#" class="qty-down"
                                                                data-product-id="<%= product.productId._id %>"><i
                                                                    class="fi-rs-angle-small-down"></i></a>
                                                            <span class="qty-val" data-product-id="<%= product.productId._id %>">
                                                                <%= product.quantity %>
                                                            </span>
                                                            <a href="#" class="qty-up"
                                                                data-product-id="<%= product.productId._id %>"><i
                                                                    class="fi-rs-angle-small-up"></i></a>
                                                        </div>
                                                    </td>

                                                    <td class="text-right" data-title="Cart">

                                                        <span class="price-span">
                                                              <%= product.total %>
                                                        </span>

                                                    </td>
                                                    <td class="action" data-title="Remove"><a
                                                            onclick="deleteProduct('<%= product.productId._id %>')"
                                                            class="text-muted"><svg xmlns="http://www.w3.org/2000/svg"
                                                                width="16" height="16" fill="red" class="bi bi-trash"
                                                                viewBox="0 0 16 16">
                                                                <path
                                                                    d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                                                                <path
                                                                    d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                                                            </svg></a></td>
                                                </tr>

                                                <tr>
                                                    <td colspan="6" class="text-end">

                                                    </td>
                                                </tr>

                                            </tbody>
                                            <% }); %>

                                    </table>
                                    </table>

                                    <table class="cart-table">
                                        <!-- Your existing table rows here -->
                                    </table>


                                </div>
                                <div class="cart-action text-end">
                                    <!-- <a class="btn  mr-10 mb-sm-15"><i class="fi-rs-shuffle mr-10"></i>Update Cart</a> -->
                                    <a class="btn " href="/shop"><i class="fi-rs-shopping-bag mr-10"></i>Continue
                                        Shopping</a>
                                </div>
                                <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>
                                <div class="row mb-50">
                                    <div class="col-lg-6 col-md-12">
                                        <!-- <div class="heading_s1 mb-3">
                                    <h4>Calculate Shipping</h4>
                                </div> -->
                                        <!-- <p class="mt-15 mb-30">Flat rate: <span class="font-xl text-brand fw-900">5%</span></p> -->
                                        <form class="field_form shipping_calculator">
                                           
                                        </form>
                                        <div class="panel-body">
                                            <p class="mb-30 font-sm">If you have a coupon code, please apply it below.
                                            </p>

                                            <div class="form-group">
                                                <input type="text" placeholder="Enter Coupon Code..." id="couponCode">
                                            </div>
                                            <script>
                                                document.addEventListener('DOMContentLoaded', function () {
                                                    const couponCodeInput = document.getElementById('couponCode');

                                                    couponCodeInput.addEventListener('input', function () {
                                                        this.value = this.value.toUpperCase();
                                                    });
                                                });
                                            </script>
                                            <div class="form-group">
                                                <h3 style="color: green;"><button id="applyButton" class="btn  btn-md"
                                                        name="login" onclick="applyCoupon()">Apply Coupon</button></h3>
                                            </div>

                                            <div class="form-group">
                                                <a data-toggle="modal" data-target="#modalAddAddress"
                                                    id="viewCoupon">View Available Coupons</a>


                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12">
                                        <div class="border p-md-4 p-30 border-radius cart-totals">
                                            <div class="heading_s1 mb-3">
                                                <h4>Cart Totals</h4>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <td class="cart_total_label">Cart Subtotal</td>
                                                            <td class="cart_total_amount">

                                                                <span class="font-lg fw-900 text-brand" id="cartTotal">₹
                                                                    <%= cart.cartTotal %></span>

                                                            </td>
                                                            <td class="cart_total_label">Coupon Discount</td>
                                                            <td class="cart_total_amount">

                                                                <span class="font-lg fw-900 text-brand" id="discount">₹
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="cart_total_label">Shipping</td>
                                                            <td class="cart_total_amount"> <i class="ti-gift mr-5"></i>
                                                                ₹ 40</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="cart_total_label">Total</td>
                                                            <td class="cart_total_amount"><strong>

                                                                    <span class="font-xl fw-900 text-brand"
                                                                        id="totalShipment">₹ <%= cart.totalShipment %>
                                                                            </span>

                                                                </strong></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <a href="/checkout" class="btn "> <i class="fi-rs-box-alt mr-10"></i>
                                                Proceed To CheckOut</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <% } else { %>

                    <!-- No products in the cart -->

                    <div class="container-fluid  mt-100">
                        <div class="row">

                            <div class="col-md-12">

                                <div class="card">
                                    <div class="card-header">
                                        <h5>Cart</h5>
                                    </div>
                                    <div class="card-body cart">
                                        <div class="col-sm-12 empty-cart-cls text-center">
                                            <img src="https://i.imgur.com/dCdflKN.png" width="130" height="130"
                                                class="img-fluid mb-4 mr-3">
                                            <h3><strong>Your Cart is Empty</strong></h3>
                                            <h4>Add something to make me happy :)</h4>
                                            <a href="/shop" class="btn btn-primary cart-btn-transform m-3"
                                                data-abc="true">continue shopping</a>


                                        </div>
                                    </div>
                                </div>


                            </div>

                        </div>

                    </div>

                    <% } %>


        </main>

        <!-- modal for showing available coupons -->

        <section>
            <div class="modal fade" id="modalAddAddress" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <!-- Modal content replaced with table -->
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h4 class="modal-title w-100 font-weight-bold">Available Coupons</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>

                                            <th>Code</th>
                                            <th>Type</th>
                                            <th>Value</th>
                                            <th>Minimum Order</th>
                                            <th>Expiry Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>


                                          <% if(cart&&cart.cartTotal!=null) { %>
                                        <% if(coupon) { %>
                                            <% coupon.forEach( item=> { %>

                                                <% if (cart.cartTotal  >= item.minOrderAmount && date <=
                                                        item.expirationDate && item.isActive==="Active" ) { %>
                                                        <tr>
                                                            <td>
                                                                <%= item.code %>
                                                            </td>
                                                            <td>
                                                                <%= item.discountType %>
                                                            </td>
                                                            <td>
                                                                <%= item.discountAmtOrPercentage %>
                                                            </td>

                                                            <td>
                                                                <%= item.minOrderAmount %>
                                                            </td>

                                                            <td>
                                                                <%= item.expirationDate.toLocaleString() %>
                                                            </td>
                                                        </tr>

                                                        <% } %>
                                                            <% }) %>
                                                                <% } %>
                                                                <% } %>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <!-- Button to open the modal -->

            </div>

        </section>

        <!-- Add the following script to handle quantity changes -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- quantity update -->
        <script>
            document.addEventListener("DOMContentLoaded",function (){
                 const qtyUpIcons = document.querySelectorAll('.qty-up')
                 const qtyDownIcons = document.querySelectorAll('.qty-down')
                   function updateGrandTotal (){
                      const priceSpans = document.querySelectorAll(".price-span")
                      let total = 0;
      
                      priceSpans.forEach((priceSpan)=>{
                          total+=parseFloat(priceSpan.textContent)
                          const cartTotalElement = document.getElementById("cartTotal");
                          const totalShipmentElement = document.getElementById("totalShipment")
                          totalShipmentElement.textContent=total+40
                          cartTotalElement.textContent = total
                      })
                   }
      
                  // forEach for quantity up
                 qtyUpIcons.forEach((icon) =>{
                  icon.addEventListener("click",function(event){
                      event.preventDefault()
      
                  const productId = icon.getAttribute("data-product-id");
                  
                  fetch('/updatequantity',{
                      method:"PUT",
                      headers: {
                       "Content-Type":"application/json"   
                      },
                      body:JSON.stringify({
                       productId,
                       action:"increase"
                      }),
                  })
                  .then(async(response) => { 
              
              if (response.ok) {
                  return response.json();
              } else {
                await  Swal.fire({
                    icon: "error",
                     title: "Oops...",
                      text: "Out of Stock!",
                    footer: '<a href="#">Why do I have this issue?</a>'
                      });
                    return location.reload()
                           }
                      })
                    .then((data)=>{
                      console.log(data.total)
                      
                      // Update the displayed quantity without realoding
                      const quantitySpan = icon.previousElementSibling;
                      console.log("quantity span:",quantitySpan);
                      
                      quantitySpan.textContent = data.quantity
                      console.log(data.quantity)
                      //Update the subtotal
                      const row = icon.closest("tr");
                      const priceSpan = row.querySelector(
                          ".price-span"
                      );
                      console.log("price span:",priceSpan);
                      priceSpan.textContent = data.total;
      
                      // Update the grand total
                      updateGrandTotal();
      
                    })
                     .catch((error)=>{
                      console.log(
                          "An error happened during the increase process: " +
                                  error  
                      )
                     });
                  
                  })
      
                 })
            
            // forEach for quantity down icon
            qtyDownIcons.forEach((icon)=>{
              icon.addEventListener("click",function(event){
                  event.preventDefault()
      
              const productId = icon.getAttribute("data-product-id");
      
              fetch('/updatequantity',{
                  method:"PUT",
                  headers:{
                     "Content-Type":"application/json" 
                  },
                  body:JSON.stringify({
                     productId,
                     action:"decrease" 
                  }),
              })
                 .then((response)=>response.json())
                 .then((data)=>{
                  console.log("quantity decreased");
                   console.log(data.total);
                   
                   // update displayed quantity without realoding
                   const quantitySpan = icon.nextElementSibling;
                   console.log("quantity span:",quantitySpan)
                  quantitySpan.textContent = data.quantity
                  console.log(data.quantity)

                   // Update the subtotal
                   const row = icon.closest("tr")
                   const priceSpan = row.querySelector(
                      ".price-span"
                   );
                  console.log("Price span",priceSpan);
                  priceSpan.textContent = data.total;
      
                  // Update the grand total
                  updateGrandTotal();
      
                 })
                 .catch((error)=>{
                  console.log(
                      "An error happened during the increase process: " +
                                  error
                  );
                 })
              })
            })
            
                        // Call this function initially to set the grand total
                        updateGrandTotal();
          })
             
              
              </script>

        <!-- delete product -->
        <script>
            async function deleteProduct(productId) {

                try {
                    Swal.fire({
                        title: "Are you sure?",
                        text: "You won't be able to revert this!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, delete it!"
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const response = await fetch('/deletecart', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ productId })
                            })
                            if (response.ok) {
                                Swal.fire({
                                    title: "Deleted!",
                                    text: "Your file has been deleted.",
                                    icon: "success"
                                }).then(() => {
                                    location.reload();
                                }).catch((error) => {
                                    console.error(error)
                                })
                            }
                        }
                    })
                } catch (error) {
                    res.status(500).json({ err: "intetnal server error" })
                }
            }

        </script>

        <!-- Preloader Start -->
        <!-- <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
        <!-- pagination -->


        <!-- pagination end -->
        <!-- Vendor JS-->



        <script defer>
            document.addEventListener('DOMContentLoaded', function () {
                // This function will be executed when the DOM content has fully loaded
                document.getElementById('preloader-active').style.display = 'none';
            });
        </script>

        <script src="/javascripts/user/applyCoupon.js"></script>

        <%- include('../USERPARTIAL/footer') %>