<%- include('../ADMIN/ADMINPARTIAL/header') %>

    <%- include('../ADMIN/ADMINPARTIAL/middle') %>






        <main class="main-wrap">
            <header class="main-header navbar">
                <div class="col-search">

                </div>
                <div class="col-nav">
                    <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i
                            class="material-icons md-apps"></i> </button>
                    <ul class="nav">

                        <li class="nav-item">
                            <a class="nav-link btn-icon darkmode"> <i class="material-icons md-nights_stay"></i> </a>
                        </li>


                        <li class="dropdown nav-item">

                            <a class="dropdown-item text-danger" href="/admin/logOut"><i
                                    class="material-icons md-exit_to_app"></i>Logout</a>
                </div>
                </li>
                </ul>
                </div>
            </header>
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title">Edit Product</h2>
                        <p>Edit Product</p>
                    </div>
                    <div>
                        <input type="text" placeholder="Search Categories" class="form-control bg-white">
                    </div>
                </div>
                <!-- edit product -->
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4>Basic</h4>
                        </div>
                        <div class="card-body">

                            <form action="/admin/editedproduct" method="post" enctype="multipart/form-data"
                                onsubmit="return validateForm()">
                                <input type="hidden" name="id" value="<%= products._id %>">

                                <!-- Product Title -->
                                <div class="mb-4">
                                    <label for="product_name" class="form-label">Product title</label>
                                    <input type="text" class="form-control" id="product_name" name="title"
                                        value="<%= products.title %>">
                                    <span style="color: red;" id="titleError"></span>
                                </div>

                                <!-- Description -->
                                <div class="mb-4">
                                    <label class="form-label">Full description</label>
                                    <textarea class="form-control" rows="4" name="description"
                                        id="description"><%= products.description %></textarea>
                                    <span style="color: red;" id="descriptionError"></span>
                                </div>

                                <!-- Price, Category, Stock -->
                                <div class="row">
                                    <div class="col-lg-4 mb-4">
                                        <label class="form-label">Price</label>
                                        <input type="text" class="form-control" name="price" id="price"
                                            value="<%= products.price %>">
                                        <span style="color: red;" id="priceError"></span>
                                    </div>

                                    <div class="col-lg-4 mb-4">
                                        <label class="form-label">Category</label>
                                        <select class="form-control" name="category" id="category">
                                            <option disabled>Choose...</option>
                                            <% categories.forEach(function(category) { %>
                                                <option value="<%= category._id %>"
                                                    <%=(category._id.toString()===products.category._id.toString())
                                                    ? 'selected' : '' %>>
                                                    <%= category.categoryName %>
                                                </option>
                                                <% }); %>
                                        </select>
                                        <span style="color: red;" id="categoryError"></span>
                                    </div>

                                    <div class="col-lg-4 mb-4">
                                        <label class="form-label">Stock</label>
                                        <input type="text" class="form-control" name="stock" id="stock"
                                            value="<%= products.stock %>">
                                        <span style="color: red;" id="stockError"></span>
                                    </div>
                                </div>

                                <!-- Discount -->
                                <div class="mb-4">
                                    <label class="form-label">Discount</label>
                                    <input type="text" class="form-control" id="discount" name="discount"
                                        value="<%= products.discount %>">
                                    <span style="color: red;" id="discountError"></span>
                                </div>

                                <!-- Cover Image -->
                                <div class="mb-4">
                                    <label class="form-label">Current Cover Image</label>
                                    <img src="<%= products.coverImage %>" alt="Cover Image" class="img-fluid"
                                        style="max-width: 150px;">
                                </div>
                                <label class="form-label">Change Cover Image</label>
                                <input type="file" name="coverImage" id="coverImage">
                                <span style="color: red;" id="imageError"></span>

                                <!-- Product Images -->
                                <!-- Product Images -->
                                <div class="mb-4">
                                    <label class="form-label">Product Images</label>
                                    <div style="display:flex; gap:15px; flex-wrap: wrap;">
                                        <% products.productImages.forEach((image, index)=> { %>
                                            <div style="position: relative; text-align:center;">
                                                <!-- Current image -->
                                                <img src="<%= image %>" width="90" height="90"
                                                    style="border:1px solid #ccc; border-radius:5px; margin-bottom:5px;"
                                                    id="preview_existing_<%= index %>">

                                                <!-- File input for replacing this slot -->
                                                <input type="file" name="newProductImages[<%= index %>]"
                                                    onchange="showPreview(event, 'preview_existing_<%= index %>')">

                                                <!-- Hidden field to keep old image if no new one uploaded -->
                                                <input type="hidden" name="existingProductImages[<%= index %>]"
                                                    value="<%= image %>">
                                            </div>
                                            <% }) %>
                                    </div>

                                    <% if (products.productImages.length < 3) { %>
                                        <p>You can add <%= 3 - products.productImages.length %> more image(s)</p>
                                        <% for (let i=products.productImages.length; i < 3; i++) { %>
                                            <div style="margin-bottom:10px;">
                                                <img id="preview_new_<%= i %>" width="90" height="90"
                                                    style="border:1px solid #ccc; border-radius:5px; display:none; margin-bottom:5px;">
                                                <input type="file" name="newProductImages[<%= i %>]"
                                                    onchange="showPreview(event, 'preview_new_<%= i %>')">
                                            </div>
                                            <% } %>
                                                <% } %>
                                </div>






                                <button type="submit" class="btn btn-primary">Update Changes</button>
                            </form>



                        </div>
                    </div>
                    <!-- edit product end -->

            </section> <!-- content-main end// -->
            <footer class="main-footer font-xs">
                <div class="row pb-30 pt-15">
                    <div class="col-sm-6">
                        <script>
                            document.write(new Date().getFullYear())
                        </script> Â©, Evara - HTML Ecommerce Template .
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-end">
                            All rights reserved
                        </div>
                    </div>
                </div>
            </footer>
        </main>
        <script>
            function showPreview(event, previewId) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.getElementById(previewId);
                        img.src = e.target.result;
                        img.style.display = "block"; // show hidden preview
                    }
                    reader.readAsDataURL(file);
                }
            }
        </script>

        <script>
            function validateForm() {
                var title = document.getElementById("product_name").value;
                var description = document.getElementById("description").value;
                var price = document.getElementById("price").value;
                var stock = document.getElementById("stock").value;
                var discount = document.getElementById("discount").value;
                var coverImage = document.getElementById("coverImage").value;
                var categorySelect = document.getElementById('category');
                var categoryError = document.getElementById('categoryError');

                // Clear previous error messages
                document.getElementById('titleError').textContent = '';
                document.getElementById('descriptionError').textContent = '';
                document.getElementById('priceError').textContent = '';
                document.getElementById('stockError').textContent = '';
                document.getElementById('discountError').textContent = '';
                document.getElementById('imageError').textContent = '';

                // Validate title
                if (title.trim() === '') {
                    document.getElementById('titleError').textContent = 'Enter title';
                    return false;
                }

                // Validate description
                if (description.trim() === '') {
                    document.getElementById('descriptionError').textContent = 'Enter description';
                    return false;
                }

                // Validate price
                if (price.trim() === '') {
                    document.getElementById('priceError').textContent = 'Please fill in the price';
                    return false;
                }
                if (isNaN(price) || parseFloat(price) < 0) {
                    document.getElementById('priceError').textContent = 'Price must be a non-negative digit';
                    return false;
                }

                // Validate category
                if (categorySelect.value === 'Choose...' || categorySelect.value === '') {
                    categoryError.textContent = 'Please select a category.';
                    return false;
                }

                // Validate stock
                if (stock.trim() === '') {
                    document.getElementById('stockError').textContent = 'Please fill in the stock';
                    return false;
                }
                if (isNaN(stock) || parseInt(stock) < 0) {
                    document.getElementById('stockError').textContent = 'Stock must be a non-negative digit';
                    return false;
                }

                // Validate discount
                if (discount.trim() === '') {
                    document.getElementById('discountError').textContent = 'Please fill in the discount';
                    return false;
                }
                if (isNaN(discount) || discount < 0 || discount > 100) {
                    document.getElementById('discountError').textContent = 'Discount should be between 0 and 100';
                    return false;
                }

                // Validate coverImage format if file is selected
                if (coverImage.trim() !== '' && !validateFileFormat(coverImage, ["jpg", "jpeg", "png"])) {
                    document.getElementById('imageError').textContent = 'Invalid file format for coverImage. Only JPG, JPEG, PNG allowed.';
                    return false;
                }

                // --- Validate each product image input ---
                const productImageInputs = document.querySelectorAll('input[name="productImages"]');
                let hasError = false;

                productImageInputs.forEach((input, idx) => {
                    const errorId = input.nextElementSibling && input.nextElementSibling.classList.contains('imageErrorSpan')
                        ? input.nextElementSibling.id
                        : null;

                    if (input.value.trim() === '') {
                        if (errorId) {
                            document.getElementById(errorId).textContent = 'This image is required';
                        } else {
                            alert(`Product image #${idx + 1} is required`);
                        }
                        hasError = true;
                    } else if (!validateFileFormat(input.value, ["jpg", "jpeg", "png"])) {
                        if (errorId) {
                            document.getElementById(errorId).textContent = 'Invalid image format';
                        } else {
                            alert(`Product image #${idx + 1} has invalid format`);
                        }
                        hasError = true;
                    }
                });

                if (hasError) return false;

                return true; // all validations passed
            }

            // Validate file extension helper
            function validateFileFormat(inputValue, allowedFormats) {
                const fileExtension = inputValue.split('.').pop().toLowerCase();
                return allowedFormats.includes(fileExtension);
            }

            // --- Delete image logic ---
            document.addEventListener('DOMContentLoaded', function () {
                const deleteButtons = document.querySelectorAll('.delete-image');

                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = this.dataset.index; // image index
                        const productId = document.getElementById('PRODUCTID').value; // product ID

                        // Confirm deletion
                        if (!confirm('Are you sure you want to delete this image?')) return;

                        fetch('/admin/delete-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ productId, index })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Image deleted successfully');
                                    location.reload(); // reload to reflect change
                                } else {
                                    alert('Failed to delete image');
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert('Error deleting image');
                            });
                    });
                });
            });
        </script>


        <!-- sweetalert link -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <!-- script for link for deleting the products individually -->
        <!-- <script src="/javascripts/admin/deleteProductImagesIndividually.js"></script> -->

        <%- include('../ADMIN/ADMINPARTIAL/footer') %>